name: Build and Deploy Resume PDFs

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "scripts/**"
      - ".github/workflows/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      RESUME_GITHUB_USER: ${{ secrets.RESUME_GITHUB_USER }}
      RESUME_FIRST_NAME: ${{ secrets.RESUME_FIRST_NAME }}
      RESUME_LAST_NAME: ${{ secrets.RESUME_LAST_NAME }}
      RESUME_TITLE: ${{ secrets.RESUME_TITLE }}
      RESUME_LOCATION: ${{ secrets.RESUME_LOCATION }}
      RESUME_PHONE: ${{ secrets.RESUME_PHONE }}
      RESUME_EMAIL: ${{ secrets.RESUME_EMAIL }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache TeX Live
        uses: actions/cache@v3
        id: cache-tex
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-texlive-${{ hashFiles('**/*.tex') }}
          restore-keys: |
            ${{ runner.os }}-texlive-

      - name: Install Dependencies
        run: npm install

      - name: Install Pandoc, LaTeX, and Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-xetex \
            texlive-fonts-recommended \
            texlive-latex-extra \
            fontconfig \
            fonts-liberation \
            fonts-dejavu

      - name: Install Mermaid CLI
        run: npm install -g @mermaid-js/mermaid-cli

      - name: Prepare Directories
        run: |
          mkdir -p pdf temp_processed markdown
          rm -f pdf/*.pdf
          rm -f markdown/*.md

      - name: Copy Source to Temp
        run: cp src/*.md temp_processed/

      - name: Process Markdown (Inject Links & Stats)
        run: |
          node scripts/update-stats.js temp_processed
          node scripts/inject-links.js temp_processed

      - name: Publish Safe Markdown to Distribution
        run: |
          NAME_PREFIX=$(node scripts/get-name.js)

          for file_path in temp_processed/*.md; do
            file_name=$(basename "$file_path")
            new_file_name="${NAME_PREFIX}_${file_name}"
            
            echo "Assembling Safe Markdown for $new_file_name..."
            node scripts/assemble.js markdown "temp_processed/$file_name" "$new_file_name" --safe
          done

      - name: Assemble Resumes with PII Headers
        run: |
          for file_path in temp_processed/*.md; do
            file_name=$(basename "$file_path")
            echo "Assembling $file_name..."
            node scripts/assemble.js temp_processed "temp_processed/$file_name" "$file_name"
          done

      - name: Render Mermaid Diagrams
        run: |
          for f in temp_processed/*.md; do
            echo "Rendering diagrams for $f"
            node scripts/mermaid-render.js "$f"
          done

      - name: Build PDFs with Pandoc
        run: |
          NAME_PREFIX=$(node scripts/get-name.js)
          MAIN_FONT="Liberation Serif"
          SANS_FONT="Liberation Sans"

          for FILE_PATH in temp_processed/*.md; do
            FILE_NAME=$(basename "$FILE_PATH")
            BASE_NAME="${FILE_NAME%.*}" 
            
            echo "Building PDF for $BASE_NAME..."
            OUTPUT_FILE="${NAME_PREFIX}_${BASE_NAME}.pdf"
            
            pandoc "$FILE_PATH" \
              -V geometry:margin=0.5in \
              -V mainfont="$MAIN_FONT" \
              -V sansfont="$SANS_FONT" \
              -V fontsize=10pt \
              -V linestretch=1.15 \
              -V "header-includes=\usepackage{enumitem} \usepackage[none]{hyphenat} \raggedright \setlist{nosep,leftmargin=*}" \
              --resource-path=temp_processed \
              -V linkcolor=blue -V urlcolor=blue \
              --pdf-engine=xelatex \
              -o "pdf/$OUTPUT_FILE"
          done

      - name: Commit and Push Safe Markdown Only
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add markdown/

          git diff --staged --quiet || git commit -m "chore: update safe markdown distribution [skip ci]"

          git push

      - name: Upload PDF Artifacts (Secure)
        uses: actions/upload-artifact@v4
        with:
          name: RyanBumstead_Resumes_PDF
          path: pdf/*.pdf
          retention-days: 90

      - name: Cleanup
        if: always()
        run: rm -rf temp_processed
