name: Build Resume as Code

on:
  push:
    branches: ["main"]
    paths:
      - "markdown/**"
      - "scripts/**"
      - "resume.config.json"
      - ".github/workflows/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Dependencies
        run: |
          npm ci
          echo "$(npm bin)" >> $GITHUB_PATH

      - name: Install Pandoc & LaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended fonts-freefont-ttf

      - name: Clean Old Artifacts
        run: |
          rm -f pdf/*.pdf

      - name: Update Portfolio Stats
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RESUME_GITHUB_USER: ${{ secrets.RESUME_GITHUB_USER }}
        run: node scripts/update-stats.js markdown

      - name: Assemble & Render
        env:
          RESUME_FIRST_NAME: ${{ secrets.RESUME_FIRST_NAME }}
          RESUME_LAST_NAME: ${{ secrets.RESUME_LAST_NAME }}
          RESUME_TITLE: ${{ secrets.RESUME_TITLE }}
          RESUME_LOCATION: ${{ secrets.RESUME_LOCATION }}
          RESUME_PHONE: ${{ secrets.RESUME_PHONE }}
          RESUME_EMAIL: ${{ secrets.RESUME_EMAIL }}
        run: |
          mkdir -p temp_md
          echo '{"args": ["--no-sandbox"]}' > puppeteer-config.json

          for file in markdown/*.md; do
            filename=$(basename "$file")
            node scripts/assemble.js temp_md "$file" "$filename"
            node scripts/mermaid-render.js "temp_md/$filename"
          done

      - name: Audit & Inject Links
        run: node scripts/inject-links.js temp_md

      - name: Compile PDFs
        env:
          RESUME_FIRST_NAME: ${{ secrets.RESUME_FIRST_NAME }}
          RESUME_LAST_NAME: ${{ secrets.RESUME_LAST_NAME }}
        run: |
          NAME_PREFIX=$(node scripts/get-name.js)
          mkdir -p pdf

          HEAD_OPTS="-V header-includes=\\usepackage{enumitem} \\usepackage[none]{hyphenat} \\raggedright \\setlist{nosep,leftmargin=*}"

          pandoc "temp_md/Resume_Recruiter.md" \
            -V geometry:margin=0.5in \
            -V mainfont="FreeSerif" \
            -V sansfont="FreeSans" \
            -V fontsize=10pt \
            -V linestretch=1.15 \
            $HEAD_OPTS \
            --resource-path="temp_md" \
            -V linkcolor=blue -V urlcolor=blue \
            --pdf-engine=xelatex \
            -o "pdf/${NAME_PREFIX}_Resume_Recruiter.pdf"

          pandoc "temp_md/Resume.md" \
            -V geometry:margin=0.5in \
            -V mainfont="FreeSerif" \
            -V sansfont="FreeSans" \
            -V fontsize=10pt \
            -V linestretch=1.15 \
            $HEAD_OPTS \
            --resource-path="temp_md" \
            -V linkcolor=blue -V urlcolor=blue \
            --pdf-engine=xelatex \
            -o "pdf/${NAME_PREFIX}_Resume.pdf"

          pandoc "temp_md/Resume_Comprehensive.md" \
            -V geometry:margin=0.5in \
            -V mainfont="FreeSerif" \
            -V sansfont="FreeSans" \
            -V fontsize=10pt \
            -V linestretch=1.15 \
            $HEAD_OPTS \
            --resource-path="temp_md" \
            -V linkcolor=blue -V urlcolor=blue \
            --pdf-engine=xelatex \
            -o "pdf/${NAME_PREFIX}_Resume_Comprehensive.pdf"

      - name: Commit Artifacts
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Generate PDFs for ${{ github.actor }} [skip ci]"
          file_pattern: "pdf/*.pdf markdown/*.md"
