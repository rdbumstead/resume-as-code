name: Build and Deploy Resume PDFs

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Dependencies
        run: npm install

      - name: Install Pandoc and LaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-xetex \
            texlive-fonts-recommended \
            texlive-latex-extra \
            curl \
            unzip \
            fontconfig

      - name: Install Fonts (Source Serif 4 and Inter)
        run: |
          mkdir -p ~/.local/share/fonts
          cd ~/.local/share/fonts

          echo "Installing Source Serif 4..."
          # [Inference] curl -L is used here to ensure redirects from GitHub are followed correctly
          curl -L -o source-serif.zip https://github.com/adobe-fonts/source-serif/releases/download/4.005/source-serif-4.005.zip \
            || echo "Source Serif 4 download failed"

          if [ -f source-serif.zip ]; then
            unzip -q source-serif.zip "TTF/*.ttf"
            mv TTF/*.ttf .
            rm -rf TTF source-serif.zip
          fi

          echo "Installing Inter..."
          curl -L -o Inter.zip https://github.com/rsms/inter/releases/download/v4.0/Inter-4.0.zip \
            || echo "Inter download failed"

          if [ -f Inter.zip ]; then
            unzip -q Inter.zip "Inter Desktop/*.ttf"
            mv "Inter Desktop"/*.ttf .
            rm -rf "Inter Desktop" Inter.zip
          fi

          fc-cache -f -v
          echo "Font installation finished"

      - name: Install Mermaid CLI
        run: npm install -g @mermaid-js/mermaid-cli

      - name: Create Output Directories
        run: |
          mkdir -p pdf
          mkdir -p temp_md
          mkdir -p temp_links

      - name: Update Stats
        run: node scripts/update-stats.js markdown
        env:
          RESUME_GITHUB_USER: ${{ secrets.RESUME_GITHUB_USER }}

      - name: Copy Source Files to temp_links
        run: |
          cp markdown/Resume_Recruiter.md temp_links/Resume_Recruiter.md
          cp markdown/Resume.md temp_links/Resume.md
          cp markdown/Resume_Comprehensive.md temp_links/Resume_Comprehensive.md

      - name: Inject Links
        run: node scripts/inject-links.js temp_links

      - name: Copy Link-Injected Files Back to Source
        run: |
          echo "Copying link-injected files back to source..."
          cp temp_links/Resume_Recruiter.md markdown/Resume_Recruiter.md
          cp temp_links/Resume.md markdown/Resume.md
          cp temp_links/Resume_Comprehensive.md markdown/Resume_Comprehensive.md
          echo "Source files updated with injected links"

      - name: Commit Updated Markdown Files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add markdown/*.md
          git diff --staged --quiet || git commit -m "chore: update markdown files with injected links [skip ci]"
          git push

      - name: Assemble Resumes with PII Headers
        run: |
          node scripts/assemble.js temp_md markdown/Resume_Recruiter.md Resume_Recruiter.md
          node scripts/assemble.js temp_md markdown/Resume.md Resume.md
          node scripts/assemble.js temp_md markdown/Resume_Comprehensive.md Resume_Comprehensive.md
        env:
          RESUME_FIRST_NAME: ${{ secrets.RESUME_FIRST_NAME }}
          RESUME_LAST_NAME: ${{ secrets.RESUME_LAST_NAME }}
          RESUME_TITLE: ${{ secrets.RESUME_TITLE }}
          RESUME_LOCATION: ${{ secrets.RESUME_LOCATION }}
          RESUME_PHONE: ${{ secrets.RESUME_PHONE }}
          RESUME_EMAIL: ${{ secrets.RESUME_EMAIL }}

      - name: Render Mermaid Diagrams
        run: |
          [ -f temp_md/Resume_Recruiter.md ] && node scripts/mermaid-render.js temp_md/Resume_Recruiter.md || true
          [ -f temp_md/Resume.md ] && node scripts/mermaid-render.js temp_md/Resume.md || true
          [ -f temp_md/Resume_Comprehensive.md ] && node scripts/mermaid-render.js temp_md/Resume_Comprehensive.md || true

      - name: Build PDFs with Pandoc
        run: |
          NAME_PREFIX=$(node scripts/get-name.js)

          # [Inference] Checking if fonts exist to set variables. XeLaTeX doesn't support comma-separated fallback strings.
          MAIN_FONT="serif"
          SANS_FONT="sans-serif"

          if fc-list | grep -q "Source Serif 4"; then
            MAIN_FONT="Source Serif 4"
          fi

          if fc-list | grep -q "Inter"; then
            SANS_FONT="Inter"
          fi

          for FILE in Resume_Recruiter.md Resume.md Resume_Comprehensive.md; do
            if [ -f "temp_md/$FILE" ]; then
              OUTPUT_FILE="${NAME_PREFIX}_$(basename "$FILE" .md).pdf"
              pandoc "temp_md/$FILE" \
                -V geometry:margin=0.5in \
                -V mainfont="$MAIN_FONT" \
                -V sansfont="$SANS_FONT" \
                -V fontsize=10pt \
                -V linestretch=1.15 \
                -V "header-includes=\usepackage{enumitem} \usepackage[none]{hyphenat} \raggedright \setlist{nosep,leftmargin=*}" \
                --resource-path=temp_md \
                -V linkcolor=blue -V urlcolor=blue \
                --pdf-engine=xelatex \
                -o "pdf/$OUTPUT_FILE"
            fi
          done
        env:
          RESUME_FIRST_NAME: ${{ secrets.RESUME_FIRST_NAME }}
          RESUME_LAST_NAME: ${{ secrets.RESUME_LAST_NAME }}

      - name: Upload PDF Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: resume-pdfs
          path: pdf/*.pdf

      - name: Cleanup
        if: always()
        run: |
          rm -rf temp_md
          rm -rf temp_links
